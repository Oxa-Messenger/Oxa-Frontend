name: Frontend Production CD

on:
  push:
    branches:
      - main

permissions:
  contents: write # Required for creating GitHub Releases

jobs:
  production-ship:
    name: Update & Build Production
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: ğŸ— Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ“š Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"

      - name: ğŸš€ Setup Expo & EAS
        uses: expo/expo-github-action@v8
        with:
          expo-version: latest
          eas-version: latest
          token: ${{ secrets.EXPO_PAT }}

      - name: ğŸ“¦ Install dependencies
        run: npm install

      # 1. SHIP OTA UPDATE (Instant update for existing users)
      - name: â˜ï¸ Publish OTA Update
        run: eas update --branch production --message "${{ github.event.head_commit.message }}"

      # 2. BUILD BINARIES (New files for new installs)
      - name: ğŸ¤– Build Android (APK)
        run: eas build --platform android --profile production --non-interactive --wait

      - name: ğŸ Build iOS (IPA)
        run: eas build --platform ios --profile production --non-interactive --wait

      # 3. CREATE GITHUB RELEASE
      - name: ğŸ“ Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ github.run_number }}
          name: Oxa Release v${{ github.run_number }}
          body: |
            ## Latest Changes
            ${{ github.event.head_commit.message }}

            **Build Number:** ${{ github.run_number }}
          draft: false
          prerelease: false
          generate_release_notes: true
          files: |
            android/app/build/outputs/apk/release/*.apk
            ./app-release.ipa
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
